
'use strict';

const fs = require('fs')
const { debuglog } = require('../constants')
const { execSync } = require("child_process");

module.exports = function (proto) {
  proto.createReadStream = function (filename) {
    let basename = path.basename(filename);
    return fs.createReadStream(`${windowsWorkDir}/${basename}`);
  }


  // windows exec.
  proto.winExecSync = function (command) {
    fs.writeFileSync(
      `${this.windowsWorkDir}/ffmped-command`,
      `#!/bin/bash\n${command}`
    );
    command = `docker run --name ffmpeg-runner --rm \
          -v ${process.cwd()}\\..\\layer\\bin:/usr/local/bin \
          -v ${this.windowsWorkDir}:${this.workDir} \
          centos:latest \
          sh ${this.workDir}/ffmped-command`;
    debuglog(command);
    execSync(command);
  }

  proto.generateCm = async function (unisCustomerCd, cmId, materials, output) {
    const initDirCommand = `mkdir ${this.windowsWorkDir} > NUL 2>&1 && \
          if ERRORLEVEL 1 cmd /c exit 0 && \
          rd /q ${this.windowsWorkDir}\\*`;
    execSync(initDirCommand);

    // S3から無音ファイルを取得
    let filePath = `${process.cwd()}\\tmp\\umesse`;
    if (!(await this.getContents(constants.s3Bucket().contents, "silent.mp3", filePath, "silent.mp3")))
      throw "getObject failed";

    let command = await this.buildGenerateCM(unisCustomerCd, cmId, materials, output);
    this.winExecSync(command)
  }
  proto.getDuration = function (input) {
    // CMの秒数を取得
    let command = this.buildGetDuration(input);
    return this.winExecSync(command).toString().replace(/\n/g, "");
  }

}