"use strict";

const Ajv = require("ajv").default;
const schema = require("./validation_schema.json");
const { constants, debuglog } = require("./constants");
const { ERROR_CODE } = require("./error");

exports.checkParams = (params, addRequired) => {
  if (!params) return ERROR_CODE.E0001000;

  const ajv = new Ajv({allErrors: true, strict: false});
  require("ajv-errors")(ajv);

  let required = Object.keys(params);
  if (addRequired && Array.isArray(addRequired))
    required = required.concat(addRequired);
  schema.required = [... new Set(required)];
  const validate = ajv.compile(schema);
  const valid = validate(params);

  let res;
  if (!valid) {
    debuglog(params);
    debuglog(JSON.stringify(validate.errors));
    res = validate.errors.sort((a, b) => {
      if (a.message > b.message) return 1;
      if (a.message < b.message) return -1;
      return 0;
    }).map((item) => `${ERROR_CODE[item.message]} (${item.message})`).join("\n");
  }
  return res;
}

exports.checkCmStatus = (beforeStatus, afterStatus) => {
  if (!beforeStatus in cmStatusMessage) return "E0002000";
  if (!afterStatus in cmStatusMessage[beforeStatus]) return "E0002000";
  return cmStatusMessage[beforeStatus][afterStatus];
}

const cmStatusMessage = Object.freeze({
  [constants.cmStatus.DELETE]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "",
    [constants.cmStatus.COMPLETE]: "E0002000",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "E0002000",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.CREATING]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "E0002000",
    [constants.cmStatus.CONVERT]: "",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "E0002000",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.COMPLETE]: {
    [constants.cmStatus.DELETE]: "",
    [constants.cmStatus.CREATING]: "",
    [constants.cmStatus.COMPLETE]: "",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.CONVERT]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "E0002000",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.SHARING]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "E0002000",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.ERROR]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "E0002000",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "E0002000",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.EXTERNAL_UPLOADING]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "E0002000",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "E0002000",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "",
  },
  [constants.cmStatus.EXTERNAL_COMPLETE]: {
    [constants.cmStatus.DELETE]: "",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
  [constants.cmStatus.EXTERNAL_ERROR]: {
    [constants.cmStatus.DELETE]: "E0002000",
    [constants.cmStatus.CREATING]: "E0002000",
    [constants.cmStatus.COMPLETE]: "",
    [constants.cmStatus.CONVERT]: "E0002000",
    [constants.cmStatus.SHARING]: "E0002000",
    [constants.cmStatus.EXTERNAL_UPLOADING]: "",
    [constants.cmStatus.EXTERNAL_COMPLETE]: "E0002000",
  },
});
