"use strict";

const Ajv = require("ajv").default;
const schema = require("./validation_schema.json");
const { debuglog, warnlog } = require("./constants");
const { ERROR_CODE } = require("./error");
const regex = "[\uD800-\uDBFF]|[\uDC00-\uDFFF]";

exports.checkParams = (params, addRequired) => {
  if (!params) return ERROR_CODE.E0001000;

  const ajv = new Ajv({ allErrors: true, strict: false });
  require("ajv-errors")(ajv);

  let required = Object.keys(params);
  if (addRequired && Array.isArray(addRequired))
    required = required.concat(addRequired);
  schema.required = [...new Set(required)];
  const validate = ajv.compile(schema);
  const valid = validate(params);

  let ret = [];
  if (!valid) {
    debuglog(JSON.stringify(params));
    debuglog(JSON.stringify(validate.errors));
    ret = validate.errors
      .sort((a, b) => {
        if (a.message > b.message) return 1;
        if (a.message < b.message) return -1;
        return 0;
      })
      .map((item) => `${ERROR_CODE[item.message]} (${item.message})`);
    warnlog(JSON.stringify({ params: params, errors: validate.errors }));
  }

  // FIXME: schemaのpatternだとemojiが上手く検知できないので下記で実施
  if (params.title && params.title.match(regex)) {
    ret.push(`${ERROR_CODE.E0001051} (E0001051)`);
  }
  if (params.description && params.description.match(regex)) {
    ret.push(`${ERROR_CODE.E0001061} (E0001061)`);
  }
  if (params.text && params.text.match(regex)) {
    ret.push(`${ERROR_CODE.E0001261} (E0001261)`);
  }
  if (params.manuscript && params.manuscript.match(regex)) {
    ret.push(`${ERROR_CODE.E0001291} (E0001291)`);
  }
  if (params.details && params.details.length > 0) {
    params.details.forEach((item) => {
      if (item.title && item.title.match(regex)) {
        ret.push(`${ERROR_CODE.E0001051} (E0001051)`);
      }
      if (item.description && item.description.match(regex)) {
        ret.push(`${ERROR_CODE.E0001061} (E0001061)`);
      }
      if (item.text && item.text.match(regex)) {
        ret.push(`${ERROR_CODE.E0001261} (E0001261)`);
      }
      if (item.manuscript && item.manuscript.match(regex)) {
        ret.push(`${ERROR_CODE.E0001291} (E0001291)`);
      }
    });
  }

  if (ret.length > 0) {
    ret = [...new Set(ret)].join("\n");
  } else {
    ret = "";
  }

  return ret;
};
